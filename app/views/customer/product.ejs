<%- include('../partials/head') %>
    <%- include('../partials/header') %>

        <main class="main-content">
            <div class="container">
                <div class="product-detail">
                    <div class="breadcrumb">
                        <a href="/">Home</a> /
                        <a href="/?category=<%= product.category._id %>">
                            <%= product.category.name %>
                        </a> /
                        <span>
                            <%= product.name %>
                        </span>
                    </div>

                    <div class="product-detail-content">
                        <div class="product-detail-image">
                            <% var productImages=[]; if (product.images && product.images.length> 0) {
                                productImages = product.images;
                                } else if (product.image) {
                                productImages = [product.image];
                                }
                                %>

                                <% if (productImages.length> 1) { %>
                                    <!-- Carousel for multiple images -->
                                    <div id="productImageCarousel" class="carousel slide" data-interval="false">
                                        <ol class="carousel-indicators">
                                            <% productImages.forEach(function(image, index) { %>
                                                <li data-target="#productImageCarousel" data-slide-to="<%= index %>"
                                                    class="<%= index === 0 ? 'active' : '' %>"></li>
                                                <% }); %>
                                        </ol>
                                        <div class="carousel-inner">
                                            <% productImages.forEach(function(image, index) { %>
                                                <div class="carousel-item <%= index === 0 ? 'active' : '' %>">
                                                    <img src="/uploads/<%= image %>" class="d-block w-100"
                                                        alt="<%= product.name %> - Image <%= index + 1 %>"
                                                        style="max-height: 500px; object-fit: contain; background-color: #f8f9fa;">
                                                </div>
                                                <% }); %>
                                        </div>
                                        <a class="carousel-control-prev" href="#productImageCarousel" role="button"
                                            data-slide="prev">
                                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                            <span class="sr-only">Previous</span>
                                        </a>
                                        <a class="carousel-control-next" href="#productImageCarousel" role="button"
                                            data-slide="next">
                                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                            <span class="sr-only">Next</span>
                                        </a>
                                    </div>

                                    <!-- Thumbnail navigation -->
                                    <div class="product-thumbnails mt-3">
                                        <% productImages.forEach(function(image, index) { %>
                                            <img src="/uploads/<%= image %>" alt="Thumbnail <%= index + 1 %>"
                                                class="thumbnail-img <%= index === 0 ? 'active' : '' %>"
                                                data-slide-to="<%= index %>"
                                                style="width: 80px; height: 80px; object-fit: cover; cursor: pointer; margin: 5px; border: 2px solid #ddd; border-radius: 5px;">
                                            <% }); %>
                                    </div>
                                    <% } else if (productImages.length===1) { %>
                                        <!-- Single image -->
                                        <img src="/uploads/<%= productImages[0] %>" alt="<%= product.name %>"
                                            style="max-width: 100%; height: auto;">
                                        <% } else { %>
                                            <!-- Fallback for no image -->
                                            <img src="/img/undraw_posting_photo.svg" alt="<%= product.name %>"
                                                style="max-width: 100%; height: auto; opacity: 0.5;">
                                            <% } %>
                        </div>

                        <div class="product-detail-info">
                            <h1>
                                <%= product.name %>
                            </h1>

                            <div class="product-meta">
                                <span class="category-badge-large">
                                    <strong>Category:</strong>
                                    <%= product.category.name %>
                                </span>
                            </div>

                            <div class="product-price-detail">
                                <h2 class="price">₹<%= product.price ? product.price.toFixed(2) : '0.00' %>
                                </h2>
                            </div>

                            <div class="product-description">
                                <h3>Description</h3>
                                <p>
                                    <%= product.description %>
                                </p>
                            </div>

                            <div class="product-actions">
                                <a href="/" class="btn btn-secondary">← Back to Products</a>
                                <a href="/?category=<%= product.category._id %>" class="btn btn-primary">
                                    View More in <%= product.category.name %>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <%- include('../partials/footer') %>

            <script>
                // Ensure DOM and Bootstrap are ready
                $(document).ready(function () {
                    // Check if carousel exists
                    var carousel = $('#productImageCarousel');
                    if (carousel.length > 0) {
                        console.log('Carousel found, initializing...');

                        // Thumbnail click handler
                        $('.thumbnail-img').on('click', function () {
                            var slideIndex = parseInt($(this).data('slide-to'));
                            console.log('Thumbnail clicked, going to slide:', slideIndex);
                            carousel.carousel(slideIndex);

                            // Update active thumbnail
                            $('.thumbnail-img').removeClass('active');
                            $(this).addClass('active');
                        });

                        // Update active thumbnail when carousel slides
                        carousel.on('slid.bs.carousel', function (e) {
                            var activeIndex = $('.carousel-item.active').index();
                            console.log('Carousel slid to index:', activeIndex);
                            $('.thumbnail-img').removeClass('active');
                            $('.thumbnail-img').eq(activeIndex).addClass('active');
                        });

                        // Also handle carousel control clicks
                        $('.carousel-control-prev, .carousel-control-next').on('click', function (e) {
                            console.log('Carousel control clicked');
                        });
                    }
                });
            </script>